<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>HOAi Voice ROI Calculator - Clean v4.0</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #000; color: #fff; }
.dashboard { display: grid; grid-template-columns: 400px 1fr; min-height: 100vh; overflow: visible !important; }
.sidebar { background: #0a0a0a; padding: 30px; overflow-y: auto; position: sticky; top: 0; height: 100vh; border-right: 2px solid #1a1a1a; }
.main-content { padding: 40px; overflow-y: auto; overflow-x: visible !important; }
.header { text-align: center; margin-bottom: 25px; padding: 30px 20px; background: linear-gradient(135deg, #4B9CD3 0%, #13294B 100%); border-radius: 12px; }
.header h1 { font-size: 2em; font-weight: 700; }
.input-group { margin-bottom: 18px; }
.input-group label { display: block; font-size: 0.85em; color: #d4d4d4; margin-bottom: 8px; font-weight: 500; }
.input-group input { background: #1a1a1a; border: 2px solid #2a2a2a; border-radius: 8px; padding: 12px; font-size: 0.95em; color: #fff; width: 100%; font-family: inherit; }
.input-group input:focus { outline: none; border-color: #4B9CD3; box-shadow: 0 0 0 3px rgba(75,156,211,0.1); }
.sidebar-title { font-size: 1.15em; font-weight: 600; margin-bottom: 15px; color: #4B9CD3; text-transform: uppercase; letter-spacing: 0.5px; }
.timeframe { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px; }
.btn { background: #2a2a2a; border: 2px solid #333; color: #aaa; padding: 10px; border-radius: 8px; cursor: pointer; font-size: 0.85em; text-align: center; font-family: inherit; transition: all 0.3s; }
.btn:hover { background: #333; border-color: #4B9CD3; transform: translateY(-1px); }
.btn.active { background: #4B9CD3; color: #fff; }
.divider { height: 2px; background: #1a1a1a; margin: 20px 0; }
.badge { background: #13294B; border-left: 4px solid #4B9CD3; padding: 18px; border-radius: 8px; margin-bottom: 30px; color: #fff; font-size: 0.95em; font-weight: 500; }
.hero { background: linear-gradient(135deg, #4B9CD3 0%, #13294B 100%); border-radius: 20px; padding: 60px 40px; text-align: center; margin-bottom: 40px; position: relative; }
.big { font-size: 6.5em; font-weight: 100; margin: 20px 0; letter-spacing: -3px; }
.grid3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 40px; overflow: visible !important; }
.grid4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 40px; overflow: visible !important; }
.card { background: #1a1a1a; border-radius: 15px; padding: 30px; text-align: center; position: relative; transition: transform 0.3s, box-shadow 0.3s; border: 1px solid #2a2a2a; overflow: visible !important; }
.card:hover { transform: translateY(-8px); box-shadow: 0 15px 40px rgba(0,0,0,0.3); border-color: #4B9CD3; }
/* Ensure grids allow tooltip overflow */
.grid3, .grid4 { overflow: visible !important; }
.card .lbl { font-size: 0.9em; color: #d4d4d4; margin-bottom: 15px; text-transform: uppercase; font-weight: 600; letter-spacing: 1px; }
.card .val { font-size: 3.2em; font-weight: 200; color: #4B9CD3; }
.card-desc { font-size: 0.95em; color: #d4d4d4; font-weight: 500; margin-top: 10px; }
.eff { border: 2px solid #4B9CD3; }
.eff:hover { border-color: #5AADDE; }
.impact { border: 2px solid #4B9CD3; background: linear-gradient(135deg, rgba(75,156,211,0.05) 0%, rgba(19,41,75,0.05) 100%); }
.impact:hover { border-color: #5AADDE; transform: translateY(-8px); }
.impact .val { color: #4B9CD3; font-size: 3.8em; }
.impact .lbl { color: #4B9CD3; }
.impact .info-icon { border-color: #4B9CD3; color: #4B9CD3; background: rgba(75,156,211,0.08); }
.impact .info-icon:hover { background: rgba(75,156,211,0.15); }
.impact .info-icon .info-tooltip { border-color: #4B9CD3; }
/* Default arrow for impact tooltips (points down when tooltip is above) */
.impact .info-tooltip::after { border-color: #4B9CD3 transparent transparent transparent; }
/* If impact cards are in top grid3 or grid4, arrow points up (tooltip is below) */
.main-content > .grid3:first-of-type .impact .info-tooltip::after,
.main-content > .grid4:first-of-type .impact .info-tooltip::after { border-color: transparent transparent #4B9CD3 transparent; }
.hero-emerald { background: linear-gradient(135deg, #6c757d 0%, #2a2a2a 100%); border-radius: 20px; padding: 60px 40px; text-align: center; margin-bottom: 40px; position: relative; }
.section { background: #1a1a1a; border-radius: 20px; padding: 40px; margin-bottom: 40px; border: 1px solid #2a2a2a; }
.section h3 { color: #4B9CD3; font-weight: 600; font-size: 1.8em; margin-bottom: 30px; }
.chart { background: #2a2a2a; border-radius: 15px; padding: 30px; margin-bottom: 30px; height: 400px; }
.show { display: block; }
.hide { display: none; }
.svc { background: #1a1a1a; border-radius: 10px; padding: 15px; margin-bottom: 12px; border: 2px solid transparent; transition: all 0.3s; }
.svc.keep { border-color: #6c757d; }
.svc.cancel { border-color: #4B9CD3; }
.svc:hover { border-color: #4B9CD3; }
.svc-header { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; cursor: pointer; }
.toggle-group { display: flex; gap: 8px; }
.toggle-btn { padding: 6px 14px; font-size: 0.8em; border-radius: 6px; cursor: pointer; transition: all 0.3s; border: 2px solid #2a2a2a; background: #0a0a0a; color: #aaa; font-family: inherit; }
.toggle-btn:hover { border-color: #4B9CD3; }
.toggle-btn.active-keep { background: #6c757d; color: #fff; border-color: #6c757d; }
.toggle-btn.active-cancel { background: #4B9CD3; color: #fff; border-color: #4B9CD3; }
.si { display: none; margin-top: 8px; }
.svc.keep .si, .svc.cancel .si { display: block; }
.hero-emerald { background: linear-gradient(135deg, #6c757d 0%, #2a2a2a 100%); border-radius: 20px; padding: 60px 40px; text-align: center; margin-bottom: 40px; position: relative; }
.section { background: #1a1a1a; border-radius: 20px; padding: 40px; margin-bottom: 40px; border: 1px solid #2a2a2a; }
.expand-btn { width: 100%; background: #2a2a2a; border: 2px solid #4B9CD3; color: #4B9CD3; padding: 18px; border-radius: 12px; cursor: pointer; font-size: 1.1em; font-weight: 600; text-align: center; margin-top: 20px; margin-bottom: 20px; transition: all 0.3s; font-family: inherit; }
.expand-btn:hover { background: #333; transform: translateY(-2px); }
.expand-btn.expanded { background: #4B9CD3; color: #fff; }
.num-box { background: rgba(75,156,211,0.05); padding: 15px; border-radius: 12px; }
.num-box-gray { background: rgba(108,117,125,0.1); padding: 15px; border-radius: 12px; }
#addBtn:hover { background: #4B9CD3; color: #fff; transform: translateY(-2px); }
#sendBtn:hover { background: #5AADDE; transform: translateY(-2px); }
.version-badge { position: fixed; bottom: 20px; right: 20px; background: #13294B; border: 2px solid #4B9CD3; padding: 10px 15px; border-radius: 8px; font-size: 0.75em; color: #4B9CD3; font-weight: 600; z-index: 1000; }

</style>
</head>
<body>
<div class="version-badge">NO TOOLTIPS v4.0</div>
<div class="dashboard">
<aside class="sidebar">
<div class="header">
<h1>HOAi Voice ROI Calculator</h1>
<p>Incremental Impact Analysis</p>
</div>

<h3 class="sidebar-title">Timeframe</h3>
<div class="timeframe" id="tfBtns">
<button class="btn" data-y="1">1 Yr</button>
<button class="btn" data-y="2">2 Yrs</button>
<button class="btn active" data-y="3">3 Yrs</button>
<button class="btn" data-y="4">4 Yrs</button>
<button class="btn" data-y="5">5 Yrs</button>
</div>

<div class="divider"></div>

<h3 class="sidebar-title">Portfolio</h3>

<div class="input-group">
<label for="comm">Communities Under Management</label>
<input type="number" id="comm" value="250" min="1">
</div>

<div class="input-group">
<label for="doors">Doors Under Management</label>
<input type="number" id="doors" value="50000" min="100">
</div>

<div class="input-group">
<label for="staff">Call Center Staff</label>
<input type="number" id="staff" value="10" min="1">
</div>

<div class="input-group">
<label for="growth">Target Number of Communities Added Annually</label>
<input type="number" id="growth" value="50" min="0">
</div>

<div class="divider"></div>

<h3 class="sidebar-title">Call Volume</h3>
<div class="input-group">
<label for="callOverride">Monthly Calls <span style="font-size:0.75em;color:#888" id="callRate"></span></label>
<input type="range" id="callSlider" min="0" max="50000" step="2500" value="10000" style="width:100%;margin-bottom:8px">
<input type="number" id="callOverride" value="10000" min="0" max="100000">
</div>

<div class="divider"></div>

<h3 class="sidebar-title">Ancillary Services</h3>
<div style="background:#1a1a1a;padding:12px;border-radius:8px;margin-bottom:12px;border-left:3px solid #4B9CD3;font-size:0.75em;color:#ccc">
<strong style="color:#4B9CD3">Decision Point:</strong> For each service, select whether you'll <strong style="color:#4B9CD3">CANCEL</strong> (save money with HOAi) or <strong style="color:#6c757d">KEEP</strong> (maintain current provider).
</div>

<div class="svc cancel" id="s1">
<div class="svc-header">
<div style="flex:1;font-size:0.9em;color:#fff">Ancillary Service 1</div>
</div>
<div class="si">
<label style="font-size:0.8em;color:#aaa;margin-bottom:4px;display:block">Service Name</label>
<input type="text" id="n1" placeholder="e.g., After-Hours Call Center" style="margin-bottom:8px;width:100%;background:#0a0a0a;border:1px solid #2a2a2a;padding:10px;border-radius:6px;color:#fff;font-size:0.85em;font-family:inherit">
<label style="font-size:0.8em;color:#aaa;margin-bottom:4px;display:block;margin-top:8px">Annual Cost</label>
<input type="number" id="c1" value="0" min="0" placeholder="0" style="width:100%;background:#0a0a0a;border:1px solid #2a2a2a;padding:10px;border-radius:6px;color:#fff;font-size:0.85em;font-family:inherit">
<label style="font-size:0.8em;color:#aaa;margin-bottom:4px;display:block;margin-top:8px">Post-HOAi Implementation</label>
<div class="toggle-group">
<button class="toggle-btn active-cancel" data-svc="1" data-action="cancel">Cancel</button>
<button class="toggle-btn" data-svc="1" data-action="keep">Keep</button>
</div>
</div>
</div>

<div id="addS"></div>

<button class="btn" id="addBtn" style="width:100%;border:2px solid #4B9CD3;color:#4B9CD3;margin-top:5px;font-weight:600">+ Add Additional Ancillary Service</button>

<div class="divider"></div>

<h3 class="sidebar-title">Email Report</h3>
<div class="input-group">
<label for="email">Email Address</label>
<input type="email" id="email" placeholder="your.email@company.com">
</div>
<button class="btn" id="sendBtn" style="width:100%;background:#4B9CD3;color:#fff;font-weight:600;border:2px solid #4B9CD3">Send Detailed Report</button>

</aside>

<main class="main-content">
<div class="badge" id="prof">Calculating...</div>

<div class="grid3">
<div class="card eff">
<div class="lbl">Cost Savings ROI</div>
<div class="num-box" style="font-size:3.8em;font-weight:100;color:#4B9CD3" id="roi">0x</div>
<div class="card-desc">Operational efficiency return</div>
</div>
<div class="card eff">
<div class="lbl">Current Fully-Loaded Cost Per Call</div>
<div style="font-size:0.75em;color:#888;margin-bottom:8px">(Year 1 - All operational costs)</div>
<div class="num-box-gray" style="font-size:3.8em;font-weight:100;color:#e0e0e0" id="cpc1">$0</div>
<div class="card-desc">Without Voice</div>
</div>
<div class="card eff">
<div class="lbl">With Voice Cost Per Call</div>
<div style="font-size:0.75em;color:#888;margin-bottom:8px">(Year 1 - Fully-loaded operational costs)</div>
<div class="num-box" style="font-size:3.8em;font-weight:100;color:#4B9CD3" id="cpc2">$0</div>
<div class="card-desc"><span id="cpcR">0</span>% reduction</div>
</div>
</div>

<div class="grid4">
<div class="card eff">
<div class="lbl">Avg Annual Savings</div>
<div class="val" id="avg">$0</div>
</div>
<div class="card eff">
<div class="lbl">Cost Reduction</div>
<div class="val" id="pct">0%</div>
</div>
<div class="card eff">
<div class="lbl">Headcount Avoided</div>
<div class="val" id="hc">0</div>
</div>
<div class="card eff">
<div class="lbl">Strategic Hours Gained</div>
<div class="val" id="hrs">0</div>
</div>
</div>

<div class="hide" id="ancSum" style="background:linear-gradient(135deg,#4B9CD3,#13294B);border-radius:15px;padding:40px;margin-bottom:40px;text-align:center">
<h4 style="font-size:1.3em;margin-bottom:10px">Service Consolidation Savings</h4>
<div style="font-size:4em;font-weight:100;margin:15px 0" id="ancTot">$0</div>
<div id="ancDetail">Cancelled services replaced by HOAi platform</div>
</div>

<section class="hero">
<h2 style="font-size:1.4em;font-weight:600;margin-bottom:20px;text-transform:uppercase;letter-spacing:1px">
Net Savings from HOAi Voice Over <span id="per">3</span> Year<span id="pl">s</span>
</h2>
<div class="big" id="sav">$0</div>
<div style="opacity:0.9;font-size:1.1em">Operational savings minus Voice platform investment</div>
</section>

<section class="hero" style="background: linear-gradient(135deg, #6c757d, #2a2a2a);">
<h2 style="font-size:1.4em;font-weight:600;margin-bottom:20px;text-transform:uppercase;letter-spacing:1px">
Revenue Growth from Improved Retention Over <span id="per2">3</span> Year<span id="pl2">s</span>
</h2>
<div class="big" id="rev">$0</div>
<div style="opacity:0.9;font-size:1.1em">Additional EBITDA from retention</div>
</section>


<section class="section">
<h3>Total Business Impact</h3>

<div class="grid3">
<div class="card impact">
<div class="lbl">Cost Savings</div>
<div class="val" id="totalCostSavings">$0</div>
<div class="card-desc">Operational efficiency</div>
</div>
<div class="card impact">
<div class="lbl">Revenue Growth</div>
<div class="val" id="totalRevGrowth">$0</div>
<div class="card-desc">Retention & referrals</div>
</div>
<div class="card impact">
<div class="lbl">Total Value Created</div>
<div class="val" id="totalBusinessImpact">$0</div>
<div class="card-desc">Combined impact</div>
</div>
</div>

<section class="hero-emerald">
<h2 style="font-size:1.4em;font-weight:600;margin-bottom:20px;text-transform:uppercase;letter-spacing:1px">
Dual-Engine ROI
</h2>
<div class="big"><span id="totalROI2">0.00</span>x</div>
<div style="opacity:0.9;font-size:1.1em">Combining cost savings + revenue growth for complete business value</div>
</section>
</section>

<section class="section">
<h3>Visual Analysis</h3>

<div style="background:#13294B;padding:25px;border-radius:15px;margin-bottom:30px;border-left:4px solid #4B9CD3">
<h4 style="color:#4B9CD3;margin-bottom:15px;font-size:1.3em">Total Savings Over <span id="ftePeriod">3</span> Years: <span id="fteTotalSavings">$1.65M</span></h4>
<p style="line-height:1.7;color:#e0e0e0;font-size:1.05em">As call volume grows 40%, traditional operations must hire 4 additional staff. HOAi Voice breaks this pattern - the gold line shows escalating annual savings from comprehensive operational improvements: avoided hiring, reduced manager oversight, lower turnover, and administrative automation. Cumulative impact compounds over time.</p>
</div>

<div class="chart"><canvas id="chFTE"></canvas></div>


<button class="expand-btn" id="expFTE">Click Here to Dive Deeper</button>
<div class="hide" id="deepFTE" style="background:#2a2a2a;padding:25px;border-radius:10px;margin-bottom:30px">
<h4 style="color:#4B9CD3;margin-bottom:15px">The Scaling Leverage Explained</h4>

<p style="line-height:1.7;color:#d4d4d4;margin-bottom:15px"><strong style="color:#6c757d">Gray Bars - Traditional Staffing:</strong> Shows how traditional call centers must scale. More calls = more people. Linear growth pattern where 40% call volume increase requires 40% staff increase. Each person handles roughly 1,000 calls/month, so capacity scales 1:1 with headcount.</p>

<p style="line-height:1.7;color:#d4d4d4;margin-bottom:15px"><strong style="color:#4B9CD3">Blue Bars - Voice Staffing:</strong> Shows the AI leverage effect. Call deflection improves from 60% → 70% as the system learns. Combined with administrative automation (7 min → 2.5 min per call), each staff member effectively handles 2,000-2,400 calls/month instead of 1,000. The bars stay flat despite 40% call growth.</p>

<p style="line-height:1.7;color:#d4d4d4;margin-bottom:15px"><strong style="color:#ffc107">Gold Line - Annual Savings:</strong> Shows the TOTAL annual operational savings each year (matches "Annual Savings Breakdown" chart below). This is comprehensive: labor savings, manager time reduction, turnover/training cuts, and administrative automation - minus platform costs. Year 1: ~$377K saved. Year 3: ~$725K saved. The accelerating curve shows both the FTE gap widening (more avoided hires) AND wage inflation making each avoided position more valuable. Sum of all years = $1.65M (header total).</p>

<div style="margin-top:20px;padding:18px;background:rgba(75,156,211,0.15);border-left:4px solid #4B9CD3;border-radius:8px">
<p style="line-height:1.6;color:#e0e0e0;margin-bottom:10px"><strong style="color:#4B9CD3">The Bottom Line:</strong> Over <span id="deepYears">3</span> years, traditional operations hired <span id="deepTradHiring">4</span> people while Voice hired <span id="deepVoiceHiring">0</span>. Total cumulative hiring costs avoided: <span id="deepTotalSavings">$1.65M</span> - no recruitment, no training, no management overhead.</p>
<p style="line-height:1.6;color:#e0e0e0;margin:0"><strong style="color:#4B9CD3">The Compounding Advantage:</strong> Year 1 saves <span id="deepY1">$377K</span>, Year 3 saves <span id="deepY3">$725K</span>. The gap grows wider (more avoided FTE) and more expensive (wage inflation) - both effects multiply together for exponential leverage.</p>
</div>
</div>


<button class="expand-btn" id="expandBtn">View Additional Charts</button>

<div class="hide" id="additionalCharts">
<div class="chart"><canvas id="ch2"></canvas></div>
<button class="expand-btn" id="exp2">Click Here to Dive Deeper</button>
<div class="hide" id="deep2" style="background:#2a2a2a;padding:25px;border-radius:10px;margin-bottom:30px">
<h4 style="color:#4B9CD3;margin-bottom:15px">Key Takeaway: Accelerating Annual Savings</h4>
<p style="line-height:1.7;color:#d4d4d4">Annual savings increase over time as wage inflation makes avoided positions more valuable and portfolio growth amplifies the efficiency advantage. Year 3 savings exceed Year 1 even though efficiency stays constant.</p>
</div>


<div class="chart"><canvas id="ch4"></canvas></div>
<button class="expand-btn" id="exp4">Click Here to Dive Deeper</button>
<div class="hide" id="deep4" style="background:#2a2a2a;padding:25px;border-radius:10px;margin-bottom:30px">
<h4 style="color:#4B9CD3;margin-bottom:15px">Key Takeaway: Dual-Engine Value Creation</h4>
<p style="line-height:1.7;color:#d4d4d4">HOAi creates value through two mechanisms: cost savings (blue) represent hard-dollar EBITDA improvements, while revenue growth (gray) represents top-line expansion from improved retention and referrals. Both engines strengthen over time.</p>
</div>
</div>

</section>
</main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script>
// Configure datalabels to be disabled by default (only enable on FTE chart)
Chart.register(ChartDataLabels);
Chart.defaults.set('plugins.datalabels', {
    display: false  // Disabled globally, enable per-chart
});
</script>
<script>
(function() {
// ============================================================================
// CONFIGURATION - All constants and assumptions
// ============================================================================
var C = {
    // Labor costs
    w: 20,                    // Base wage per hour
    wg: 0.035,                // Annual wage growth rate (3.5%)
    sr: 35.83,                // Supervisor rate per hour
    tr: 0.30,                 // Turnover rate (30% annually)
    hpm: 160,                 // Hours per month per FTE
    
    // Call center capacity (ADDED for call-volume-driven staffing)
    callsPerStaffPerMonth: 1000,  // Benchmark: 1 FTE handles ~1,000 calls/month
    
    // AI efficiency parameters
    phoneAI: 0.60,            // AI deflection rate: 60% of ALL incoming calls (Voice answers 100%, deflects 60%)
    deflectionImprovement: 0.05,  // Deflection improves 5% per year as AI learns (60% → 65% → 70%)
    
    // Manager oversight
    mgrSalary: 70000,         // Annual manager salary
    mgrOversight: 0.40,       // Percentage of STAFF-HANDLED calls requiring manager review
    mgrMinutesPerCall: 12,    // Minutes spent per oversight call
    
    // Follow-up work
    baselineFollowUpMinutes: 7,      // Minutes of follow-up per call (baseline - all calls)
    voiceFollowUpMinutes: 2.5,       // Minutes of follow-up per STAFF-HANDLED call only
    voiceFollowUpOnlyStaffCalls: true,  // AI-deflected calls require 0 min follow-up (fully autonomous)
    
    // Revenue model
    rpd: 250,                 // Revenue per door annually
    ebitda: 0.15,             // EBITDA margin (15%)
    bcr: 0.12,                // Base churn rate (12%)
    rfr: 0.15,                // Referral rate (15%)
    churnReduction: 0.25,     // Churn reduction from HOAi (25%)
    
    // Pricing packages
    pkg: [
        { n: 'Basic', b: 1250, c: 500, r: 2.75 },
        { n: 'Standard', b: 2250, c: 1000, r: 2.48 },
        { n: 'Professional', b: 4000, c: 2000, r: 2.20 },
        { n: 'Business', b: 6600, c: 4000, r: 1.82 },
        { n: 'Enterprise', b: 7500, c: 6000, r: 1.38 }
    ]
};

// State object (FIXED: removed unused 'se' property)
var S = { 
    tf: 3,      // Timeframe in years
    sc: 1,      // Service count
    ms: 10      // Max services
};

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================
function g(id) { return document.getElementById(id); }
function f(n) { return '$' + Math.round(n).toLocaleString(); }

// ============================================================================
// PRICING CALCULATION
// ============================================================================
function fpkg(cv) {
    if (cv <= 1000) return { p: C.pkg[0], m: C.pkg[0].b + Math.max(0, cv - C.pkg[0].c) * C.pkg[0].r, a: (C.pkg[0].b + Math.max(0, cv - C.pkg[0].c) * C.pkg[0].r) * 12, o: Math.max(0, cv - C.pkg[0].c) };
    if (cv <= 2500) return { p: C.pkg[1], m: C.pkg[1].b + Math.max(0, cv - C.pkg[1].c) * C.pkg[1].r, a: (C.pkg[1].b + Math.max(0, cv - C.pkg[1].c) * C.pkg[1].r) * 12, o: Math.max(0, cv - C.pkg[1].c) };
    if (cv <= 5000) return { p: C.pkg[2], m: C.pkg[2].b + Math.max(0, cv - C.pkg[2].c) * C.pkg[2].r, a: (C.pkg[2].b + Math.max(0, cv - C.pkg[2].c) * C.pkg[2].r) * 12, o: Math.max(0, cv - C.pkg[2].c) };
    if (cv <= 8000) return { p: C.pkg[3], m: C.pkg[3].b + Math.max(0, cv - C.pkg[3].c) * C.pkg[3].r, a: (C.pkg[3].b + Math.max(0, cv - C.pkg[3].c) * C.pkg[3].r) * 12, o: Math.max(0, cv - C.pkg[3].c) };
    return { p: C.pkg[4], m: C.pkg[4].b + Math.max(0, cv - C.pkg[4].c) * C.pkg[4].r, a: (C.pkg[4].b + Math.max(0, cv - C.pkg[4].c) * C.pkg[4].r) * 12, o: Math.max(0, cv - C.pkg[4].c) };
}

// ============================================================================
// ANCILLARY SERVICES CALCULATION
// ============================================================================
function anc() {
    var tTrad = 0, tHoai = 0;
    for (var i = 1; i <= S.sc; i++) {
        var s = g('s' + i);
        if (s) {
            var c = g('c' + i);
            var cost = c && c.value ? Number(c.value) : 0;
            if (s.classList.contains('cancel')) {
                tTrad += cost;
            } else if (s.classList.contains('keep')) {
                tTrad += cost;
                tHoai += cost;
            }
        }
    }
    return { trad: tTrad, hoai: tHoai };
}

// ============================================================================
// CORRECTED YEAR CALCULATION - All fixes implemented here
// ============================================================================
function cy(y, co, dr, st_t, st_h, cv, ancCosts) {
    // Year-adjusted rates
    var w = C.w * Math.pow(1 + C.wg, y - 1);
    var sr = C.sr * Math.pow(1 + C.wg, y - 1);

    // ========================================================================
    // BASELINE: Current Operations (Without Voice)
    // ========================================================================
    
    // Labor burden (traditional staffing)
    var lb = st_t * C.hpm * w * 12;
    
    // Turnover costs
    var tc = st_t * C.tr;  // Number of turnovers
    
    // CORRECTED: Training costs broken down properly
    // 30 hours manager training + 40 hours onboarding
    var trainingHours = 30;
    var onboardingHours = 40;
    var recruitmentCost = 4700;
    var tn = (tc * recruitmentCost) + (tc * ((trainingHours * sr) + (onboardingHours * w)));
    
    // Turnover lost productivity (75% efficiency during 12-week ramp)
    var tl = tc * w * C.hpm * 12 * 0.75;
    
    // NOTE: Overhead and quality costs removed from model per user request
    // var ov = lb * 0.05;
    // var ql = lb * 0.05;

    // Manager oversight costs
    var mgrHourlyRate = (C.mgrSalary / 52 / 40) * Math.pow(1 + C.wg, y - 1);
    var annualCalls = cv * 12;
    var oversightCalls = annualCalls * C.mgrOversight;
    var oversightHours = oversightCalls * (C.mgrMinutesPerCall / 60);
    var mo = oversightHours * mgrHourlyRate;
    
    // Baseline follow-up work (NEW: All calls require follow-up activities)
    var baselineFollowUpHours = (annualCalls * C.baselineFollowUpMinutes) / 60;
    var baselineFollowUpCost = baselineFollowUpHours * w;

    var baselineTotal = lb + tn + tl + mo + baselineFollowUpCost + ancCosts.trad;

    // ========================================================================
    // INCREMENTAL IMPACT: Adding HOAi Voice
    // ========================================================================

    // Calculate optimal staffing with Voice
    // CORRECTED: Voice deflects 60% of ALL calls (answers 100% of calls, deflects 60%)
    var aiDeflectedWork = st_t * C.phoneAI;  // 60% of all work deflected
    var requiredStaffing = st_t - aiDeflectedWork;
    
    // Apply minimum staffing constraints
    var minStaff = Math.max(2, Math.ceil(co / 150));
    var rs = Math.max(minStaff, Math.ceil(requiredStaffing));

    // CORRECTED: Staff reduction from traditional baseline (st_t), not HOAi estimate (st_h)
    var staffReduction = st_t - rs;

    // SAVINGS from Voice:
    
    // 1. Direct labor savings
    var laborSavings = staffReduction * C.hpm * w * 12;
    
    // 2. Manager oversight savings (Voice handles calls that would need review)
    var voiceDeflection = C.phoneAI;  // 60% of all calls deflected
    var managerSavings = (annualCalls * C.mgrOversight * voiceDeflection) * (C.mgrMinutesPerCall / 60) * mgrHourlyRate;
    
    // CORRECTED: All proportional savings now use st_t as denominator
    // 3. Turnover savings (proportional to staff reduction)
    var turnoverSavings = (staffReduction / st_t) * tl;
    
    // NOTE: Overhead and quality savings removed from model per user request
    // var overheadSavings = (staffReduction / st_t) * ov;
    // var qualitySavings = (staffReduction / st_t) * ql;
    
    // 4. Training/recruitment savings (proportional to staff reduction)
    var trainingSavings = (staffReduction / st_t) * tn;
    
    // 5. Follow-up work savings (CORRECTED: Only staff-handled calls require follow-up)
    // AI-deflected calls: 0 min follow-up (fully autonomous)
    // Staff-handled calls: 2.5 min follow-up each
    var voiceDeflectionPct = C.phoneAI;  // Use base deflection rate for Year 1 calculation
    var staffHandledCalls = annualCalls * (1 - voiceDeflectionPct);  // 40% of calls transferred to staff
    var voiceFollowUpHours = (staffHandledCalls * C.voiceFollowUpMinutes) / 60;
    var voiceFollowUpCost = voiceFollowUpHours * w;
    var followUpSavings = baselineFollowUpCost - voiceFollowUpCost;

    var totalSavings = laborSavings + managerSavings + turnoverSavings + trainingSavings + followUpSavings;

    // NEW COSTS from Voice:
    
    // 1. Platform subscription
    var pr = fpkg(cv);
    var platformCost = pr.a;
    
    // 2. Follow-up work cost already calculated above

    var totalNewCosts = platformCost + voiceFollowUpCost;

    // Net impact (positive = saves money)
    var netVoiceImpact = totalSavings - totalNewCosts;
    
    // FIXED: Subtract ancillary savings so cancelled services reduce Voice cost properly
    var ancillarySavings = ancCosts.trad - ancCosts.hoai;
    var withVoiceTotal = baselineTotal - netVoiceImpact - ancillarySavings;
    
    // Platform-only cost (for cost-per-call comparison)
    var platformOnlyTotal = platformCost + ancCosts.hoai;

    return { 
        t: { to: baselineTotal }, 
        h: { to: withVoiceTotal }, 
        platformOnly: { to: platformOnlyTotal },  // NEW: Platform cost only
        pr: pr, 
        sv: netVoiceImpact,
        ts: st_t, 
        hs: rs,
        voiceBreakdown: {
            laborSavings: laborSavings,
            managerSavings: managerSavings,
            turnoverSavings: turnoverSavings,
            trainingSavings: trainingSavings,
            followUpSavings: followUpSavings,
            totalSavings: totalSavings,
            platformCost: platformCost,
            followUpCost: voiceFollowUpCost,
            totalNewCosts: totalNewCosts,
            netImpact: netVoiceImpact
        },
        dr: dr, 
        co: co, 
        cv: cv 
    };
}

// ============================================================================
// MAIN CALCULATION FUNCTION
// ============================================================================
function calc() {
    try {
        var co = Number(g('comm').value);
        var dr = Number(g('doors').value);
        var cs = Number(g('staff').value);
        var gr = Number(g('growth').value);
        var cv = Number(g('callOverride').value);
        var ancCosts = anc();

        if (!co || !dr || !cs || !cv) return;

        var dpc = dr / co;
        
        // FIXED: Call-volume-driven staffing model
        // Uses industry benchmark from configuration

        var res = [];
        var tsv = 0, trv = 0, trt = 0;

        for (var y = 1; y <= S.tf; y++) {
            var yc = co + (gr * (y - 1));
            var yd = Math.round(yc * dpc);
            var ycv = Math.round(cv * (yd / dr));

            // FIXED: Traditional staffing driven by call volume (scales linearly)
            var callDrivenStaff = Math.ceil(ycv / C.callsPerStaffPerMonth);
            var minStaff = Math.max(2, Math.ceil(yc / 150));  // Minimum for coverage
            var ys_t = Math.max(minStaff, callDrivenStaff);

            // IMPROVED: HOAi staffing with deflection rate improvement over time
            // Voice answers 100% of calls, deflects 60-70% autonomously
            var baseDeflection = C.phoneAI;  // 60% in Year 1
            var deflectionImprovement = (y - 1) * C.deflectionImprovement;  // +5% improvement per year
            var actualDeflection = Math.min(0.80, baseDeflection + deflectionImprovement);  // Cap at 80%
            
            // Voice deflects this percentage of ALL calls (not just phone calls)
            var voiceDeflection = actualDeflection;  // 60% Year 1, 65% Year 2, 70% Year 3
            var adjustedCallVolume = ycv * (1 - voiceDeflection);  // Calls requiring staff handling
            
            // Additional 5% efficiency from staff proficiency with tools
            var efficiencyFactor = 1 + (y - 1) * 0.05;
            
            var hoaiCallDrivenStaff = Math.ceil(adjustedCallVolume / (C.callsPerStaffPerMonth * efficiencyFactor));
            var ys_h = Math.max(minStaff, hoaiCallDrivenStaff);

            var r = cy(y, yc, yd, ys_t, ys_h, ycv, ancCosts);

            // Revenue impact calculation
            var ch = C.bcr * (1 - C.churnReduction);
            var rt = yc * C.bcr * ((C.bcr - ch) / C.bcr);
            var pp = C.rpd * C.ebitda;
            r.rv = { to: (rt * dpc * pp) + (rt * C.rfr * dpc * pp) };

            tsv += r.sv;
            trv += r.rv.to;
            trt += rt;
            res.push(r);
        }

        rnd(res, tsv, trv, trt, ancCosts);
        chts(res);
    } catch(e) {
        console.error('Error:', e);
    }
}

// ============================================================================
// RENDER RESULTS
// ============================================================================
function rnd(res, sv, rv, rt, ancCosts) {
    var y1 = res[0];
    var l = res[res.length - 1];
    var thc = 0, ti = 0, tt = 0, thr = 0, totalGrossSavings = 0;
    
    for (var i = 0; i < res.length; i++) {
        thc += res[i].ts - res[i].hs;
        ti += res[i].voiceBreakdown.platformCost;
        totalGrossSavings += res[i].voiceBreakdown.totalSavings;
        tt += res[i].t.to;
        var avoidedStaff = res[i].ts - res[i].hs;
        var hoursPerYear = avoidedStaff * C.hpm * 12;
        thr += hoursPerYear;
    }

    var pd = l.pr.o > 0 ? l.pr.p.n + ' + ' + Math.round(l.pr.o) + ' ovg' : l.pr.p.n;
    
    // FIXED: Calculate actual communities-per-staff ratios from results
    var year1Ratio = y1.co / y1.hs;
    var finalYearRatio = l.co / l.hs;

    g('prof').innerHTML = '<strong>Recommended Package:</strong> ' + pd + ' | <strong>Communities Per Call Staff:</strong> ' + year1Ratio.toFixed(1) + ' : 1 (scales to ' + finalYearRatio.toFixed(1) + ' : 1)';

    g('per').textContent = S.tf;
    g('pl').textContent = S.tf > 1 ? 's' : '';
    if (g('per2')) g('per2').textContent = S.tf;
    if (g('pl2')) g('pl2').textContent = S.tf > 1 ? 's' : '';

    g('sav').textContent = f(sv);
    g('rev').textContent = f(rv);
    
    // Debug logging
    console.log('=== DETAILED CALCULATION DEBUG ===');
    console.log('Net Savings (sv):', sv);
    console.log('Revenue (rv):', rv);
    console.log('Gross Operational Savings (totalGrossSavings):', totalGrossSavings);
    console.log('Platform Investment (ti):', ti);
    console.log('---');
    console.log('Cost-Only ROI:', (totalGrossSavings / ti).toFixed(2), 'x');
    console.log('Dual-Engine ROI:', ((totalGrossSavings + rv) / ti).toFixed(2), 'x');
    console.log('Revenue adds:', (rv / ti).toFixed(2), 'x to ROI');
    console.log('==================================');
    
    g('avg').textContent = f(sv / S.tf);
    g('pct').textContent = Math.round((sv / tt) * 100) + '%';
    g('hc').textContent = thc;
    g('hrs').textContent = thr.toLocaleString();
    
    // Debug logging
    console.log('=== ROI CALCULATION DEBUG ===');
    console.log('totalGrossSavings:', totalGrossSavings);
    console.log('rv (revenue):', rv);
    console.log('ti (platform investment):', ti);
    console.log('Cost-Only ROI:', (totalGrossSavings / ti).toFixed(2));
    console.log('Dual-Engine ROI:', ((totalGrossSavings + rv) / ti).toFixed(2));
    console.log('============================');
    
    g('roi').textContent = (totalGrossSavings / ti).toFixed(2) + 'x';  // Cost savings ROI only

    var cp1 = y1.t.to / (y1.cv * 12);
    var cp2 = y1.h.to / (y1.cv * 12);  // OPTION A: Use fully-loaded Voice cost (apples-to-apples)
    g('cpc1').textContent = '$' + cp1.toFixed(2);
    g('cpc2').textContent = '$' + cp2.toFixed(2);

    var cpcR = Math.round(((cp1 - cp2) / cp1) * 100);
    if (g('cpcR')) g('cpcR').textContent = cpcR;

    var ancSavings = (ancCosts.trad - ancCosts.hoai) * S.tf;
    var asm = g('ancSum');
    if (asm && ancSavings > 0) {
        asm.classList.remove('hide');
        asm.classList.add('show');
        g('ancTot').textContent = f(ancSavings);
        var cancelCount = 0;
        for (var i = 1; i <= S.sc; i++) {
            var s = g('s' + i);
            if (s && s.classList.contains('cancel')) cancelCount++;
        }
        g('ancDetail').textContent = cancelCount + ' service' + (cancelCount !== 1 ? 's' : '') + ' cancelled, savings realized with HOAi platform';
    } else if (asm) {
        asm.classList.add('hide');
    }

    var be = (C.phoneWork * C.phoneAI) * 100;

    // Tooltip population code removed - no tooltips in this version
    
    // Update Total Business Impact section
    var totalCostSavings = g('totalCostSavings');
    var totalRevGrowth = g('totalRevGrowth');
    var totalBusinessImpact = g('totalBusinessImpact');
    var totalROI = g('totalROI');
    var totalROI2 = g('totalROI2');
    
    // Update ROI breakdown tooltip values
    var roiSavings = g('roiSavings');
    var roiRevenue = g('roiRevenue');
    var roiTotal = g('roiTotal');
    var roiInvestment = g('roiInvestment');
    
    // Display net savings to user (what they actually get)
    if (totalCostSavings) totalCostSavings.textContent = f(sv);
    if (totalRevGrowth) totalRevGrowth.textContent = f(rv);
    if (totalBusinessImpact) totalBusinessImpact.textContent = f(sv + rv);
    
    // Calculate Dual-Engine ROI: (Gross Operational Savings + Revenue Growth) / Platform Investment
    // Note: Use gross savings (before platform costs) because ROI shows value generated per dollar invested
    var roiMultiple = ti > 0 ? (totalGrossSavings + rv) / ti : 0;
    if (totalROI) totalROI.textContent = roiMultiple.toFixed(2);
    if (totalROI2) totalROI2.textContent = roiMultiple.toFixed(2);
    
    // Update tooltip breakdown values (shows the ROI calculation components)
    if (roiSavings) roiSavings.textContent = f(totalGrossSavings);  // Gross operational savings
    if (roiRevenue) roiRevenue.textContent = f(rv);
    if (roiTotal) roiTotal.textContent = f(totalGrossSavings + rv);  // Total value generated
    if (roiInvestment) roiInvestment.textContent = f(ti);
    
    // Update FTE deep dive explanation with dynamic values
    if (res && res.length > 0) {
        var tradHiring = res[res.length - 1].ts - res[0].ts;
        var voiceHiring = res[res.length - 1].hs - res[0].hs;
        
        var deepTradHiring = g('deepTradHiring');
        var deepVoiceHiring = g('deepVoiceHiring');
        
        if (deepTradHiring) deepTradHiring.textContent = tradHiring;
        if (deepVoiceHiring) deepVoiceHiring.textContent = voiceHiring;
        
        // Calculate cumulative total savings and individual year values
        var deepTotalSavings = g('deepTotalSavings');
        var deepYears = g('deepYears');
        var deepY1 = g('deepY1');
        var deepY3 = g('deepY3');
        
        if (deepTotalSavings) {
            var totalSavingsAllYears = 0;
            for (var i = 0; i < res.length; i++) {
                totalSavingsAllYears += res[i].sv;  // Use comprehensive annual savings
            }
            deepTotalSavings.textContent = f(totalSavingsAllYears);
        }
        
        // Update header total (uses same comprehensive savings)
        var fteTotalSavings = g('fteTotalSavings');
        var ftePeriod = g('ftePeriod');
        if (fteTotalSavings) {
            var headerTotal = 0;
            for (var i = 0; i < res.length; i++) {
                headerTotal += res[i].sv;
            }
            fteTotalSavings.textContent = f(headerTotal);
        }
        if (ftePeriod) {
            ftePeriod.textContent = S.tf;
        }
        
        if (deepYears) deepYears.textContent = S.tf;
        
        if (deepY1 && res.length >= 1) {
            deepY1.textContent = f(res[0].sv);  // Year 1 comprehensive savings
        }
        
        if (deepY3 && res.length >= 3) {
            deepY3.textContent = f(res[2].sv);  // Year 3 comprehensive savings
        } else if (deepY3 && res.length > 0) {
            var lastIdx = res.length - 1;
            deepY3.textContent = f(res[lastIdx].sv);  // Last year savings
        }
    }

    updateCallRate();
}

function updateCallRate() {
    var doors = Number(g('doors').value);
    var calls = Number(g('callOverride').value);
    var rateEl = g('callRate');
    if (rateEl && doors > 0 && calls > 0) {
        var pct = (calls / doors) * 100;
        rateEl.textContent = '(' + pct.toFixed(2) + '% of doors call monthly)';
    }
}

// ============================================================================
// CHARTING FUNCTIONS
// ============================================================================
function chts(res) {
    if (!res || res.length === 0) return;

    var lb = [];
    for (var i = 0; i < res.length; i++) lb.push('Y' + (i+1));

    // FTE Comparison Chart - OPTIMIZED: Staffing gap with total savings impact
    var traditionalFTE = [], voiceFTE = [], annualSavings = [];
    for (var m = 0; m < res.length; m++) {
        traditionalFTE.push(res[m].ts);
        voiceFTE.push(res[m].hs);
        // Use annual savings from comprehensive calculation (matches ch2)
        annualSavings.push(Math.round(res[m].sv));
    }

    var cFTE = g('chFTE');
    if (cFTE) {
        if (window.chartFTE) window.chartFTE.destroy();
        window.chartFTE = new Chart(cFTE.getContext('2d'), {
            type: 'bar',
            data: {
                labels: lb,
                datasets: [
                    { 
                        label: 'Traditional (Must Scale with Volume)', 
                        data: traditionalFTE, 
                        backgroundColor: 'rgba(108,117,125,0.8)',
                        borderColor: '#6c757d',
                        borderWidth: 2,
                        barThickness: 60,
                        yAxisID: 'y',
                        datalabels: {
                            color: '#fff',
                            anchor: 'end',
                            align: 'top',
                            offset: 6,
                            font: { size: 18, weight: 'bold' },
                            formatter: function(value) { return value + ' FTE'; }
                        }
                    },
                    { 
                        label: 'Voice (Scales Without Hiring)', 
                        data: voiceFTE, 
                        backgroundColor: 'rgba(75,156,211,0.9)',
                        borderColor: '#4B9CD3',
                        borderWidth: 3,
                        barThickness: 60,
                        yAxisID: 'y',
                        datalabels: {
                            color: '#fff',
                            anchor: 'end',
                            align: 'top',
                            offset: 6,
                            font: { size: 18, weight: 'bold' },
                            formatter: function(value) { return value + ' FTE'; }
                        }
                    },
                    {
                        label: 'Annual Savings',
                        data: annualSavings,
                        type: 'line',
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255,193,7,0.2)',
                        borderWidth: 4,
                        pointRadius: 8,
                        pointBackgroundColor: '#ffc107',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 3,
                        fill: true,
                        yAxisID: 'y2',
                        datalabels: {
                            color: '#ffc107',
                            backgroundColor: 'rgba(0,0,0,0.7)',
                            borderColor: '#ffc107',
                            borderWidth: 2,
                            borderRadius: 6,
                            padding: 6,
                            anchor: 'end',
                            align: 'top',
                            offset: 12,
                            font: { size: 15, weight: 'bold' },
                            formatter: function(value) { 
                                return '$' + Math.round(value/1000) + 'K'; 
                            }
                        }
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: { 
                    legend: { 
                        display: true,
                        position: 'top',
                        labels: { 
                            color: '#fff', 
                            font: { size: 14, weight: '600' },
                            padding: 15,
                            usePointStyle: true,
                            generateLabels: function(chart) {
                                var labels = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                labels.forEach(function(label, i) {
                                    if (i === 0) label.pointStyle = 'rect';
                                    if (i === 1) label.pointStyle = 'rect';
                                    if (i === 2) label.pointStyle = 'circle';
                                });
                                return labels;
                            }
                        }
                    }, 
                    title: { 
                        display: true, 
                        text: 'The Scaling Advantage: Grow 40% Without Hiring', 
                        color: '#4B9CD3',
                        font: { size: 20, weight: 'bold' },
                        padding: { top: 10, bottom: 30 }
                    },
                    tooltip: { 
                        enabled: true,
                        backgroundColor: 'rgba(0,0,0,0.95)',
                        padding: 14,
                        titleColor: '#4B9CD3',
                        titleFont: { size: 14, weight: 'bold' },
                        bodyColor: '#fff',
                        bodyFont: { size: 13 },
                        borderColor: '#4B9CD3',
                        borderWidth: 2,
                        callbacks: {
                            label: function(context) {
                                var label = context.dataset.label || '';
                                if (context.datasetIndex === 2) {
                                    return label + ': $' + Math.round(context.parsed.y).toLocaleString();
                                }
                                return label + ': ' + context.parsed.y + ' FTE';
                            }
                        }
                    },
                    datalabels: { display: true }
                },
                scales: {
                    y: { 
                        position: 'left',
                        beginAtZero: true,
                        max: Math.max(...traditionalFTE) + 3,
                        ticks: { 
                            color: '#aaa', 
                            font: { size: 13 },
                            stepSize: 2,
                            callback: function(value) { return value + ' FTE'; }
                        }, 
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        title: {
                            display: true,
                            text: 'Call Center Staffing',
                            color: '#aaa',
                            font: { size: 14, weight: '600' }
                        }
                    },
                    y2: {
                        position: 'right',
                        beginAtZero: true,
                        max: Math.max(...annualSavings) * 1.15,
                        ticks: {
                            color: '#ffc107',
                            font: { size: 13, weight: '600' },
                            callback: function(value) { 
                                return '$' + Math.round(value/1000) + 'K'; 
                            }
                        },
                        grid: { 
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Annual Savings',
                            color: '#ffc107',
                            font: { size: 14, weight: 'bold' }
                        }
                    },
                    x: { 
                        ticks: { 
                            color: '#d4d4d4', 
                            font: { size: 15, weight: 'bold' }
                        }, 
                        grid: { display: false }
                    }
                },
                layout: {
                    padding: { top: 15, bottom: 10 }
                }
            }
        });
    }


    var sd = [];
    for (var k = 0; k < res.length; k++) sd.push(res[k].sv);

    var c2 = g('ch2');
    if (c2) {
        if (window.chart2) window.chart2.destroy();
        window.chart2 = new Chart(c2.getContext('2d'), {
            type: 'bar',
            data: { labels: lb, datasets: [{ label: 'Annual Savings', data: sd, backgroundColor: '#4B9CD3', borderColor: '#4B9CD3', borderWidth: 1 }] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#fff' } }, title: { display: true, text: 'Annual Savings Breakdown', color: '#fff' } },
                scales: {
                    y: { ticks: { color: '#aaa', callback: function(v) { return '$' + Math.round(v/1000) + 'K'; } }, grid: { color: '#333' } },
                    x: { ticks: { color: '#aaa' }, grid: { color: '#333' } }
                }
            }
        });
    }


    var rd = [];
    for (var n = 0; n < res.length; n++) rd.push(res[n].rv.to);

    var c4 = g('ch4');
    if (c4) {
        if (window.chart4) window.chart4.destroy();
        window.chart4 = new Chart(c4.getContext('2d'), {
            type: 'bar',
            data: {
                labels: lb,
                datasets: [
                    { label: 'Cost Savings', data: sd, backgroundColor: '#4B9CD3', borderColor: '#4B9CD3', borderWidth: 1 },
                    { label: 'Revenue Growth', data: rd, backgroundColor: '#6c757d', borderColor: '#6c757d', borderWidth: 1 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#fff' } }, title: { display: true, text: 'Complete Business Impact', color: '#fff' } },
                scales: {
                    y: { stacked: true, ticks: { color: '#aaa', callback: function(v) { return '$' + Math.round(v/1000) + 'K'; } }, grid: { color: '#333' } },
                    x: { stacked: true, ticks: { color: '#aaa' }, grid: { color: '#333' } }
                }
            }
        });
    }
}

// ============================================================================
// UI INTERACTION FUNCTIONS
// ============================================================================
function toggleCharts() {
    var div = g('additionalCharts');
    var btn = g('expandBtn');
    if (div && btn) {
        if (div.classList.contains('show')) {
            div.classList.remove('show');
            div.classList.add('hide');
            btn.classList.remove('expanded');
            btn.textContent = 'View Additional Charts';
        } else {
            div.classList.remove('hide');
            div.classList.add('show');
            btn.classList.add('expanded');
            btn.textContent = 'Hide Additional Charts';
        }
    }
}

function toggleDeep(n) {
    var div = g('deep' + n);
    var btn = g('exp' + n);
    if (div && btn) {
        if (div.classList.contains('show')) {
            div.classList.remove('show');
            div.classList.add('hide');
            btn.textContent = 'Click Here to Dive Deeper';
            btn.classList.remove('expanded');
        } else {
            div.classList.remove('hide');
            div.classList.add('show');
            btn.textContent = 'Hide Analysis';
            btn.classList.add('expanded');
        }
    }
}

function sendEmail() {
    var emailInput = g('email');
    if (!emailInput) return;

    var email = emailInput.value;
    if (!email || email.indexOf('@') === -1) {
        alert('Please enter a valid email address.');
        return;
    }

    var subject = 'HOAi Voice ROI Analysis Results (CORRECTED)';
    var body = 'View your complete corrected analysis: ' + window.location.href;
    window.location.href = 'mailto:' + email + '?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
}

function toggleSvc(n, action) {
    var s = g('s' + n);
    if (!s) return;
    s.classList.remove('keep', 'cancel');
    s.classList.add(action);
    var btns = s.querySelectorAll('.toggle-btn');
    btns.forEach(function(btn) {
        btn.classList.remove('active-keep', 'active-cancel');
        if (btn.getAttribute('data-action') === action) {
            btn.classList.add('active-' + action);
        }
    });
    calc();
}

function addS() {
    if (S.sc >= S.ms) return;
    S.sc++;
    var n = S.sc;
    var d = document.createElement('div');
    d.className = 'svc cancel';
    d.id = 's' + n;

    var h = document.createElement('div');
    h.className = 'svc-header';

    var l = document.createElement('div');
    l.textContent = 'Ancillary Service ' + n;
    l.style.cssText = 'flex:1;font-size:0.9em;color:#fff';

    h.appendChild(l);

    var si = document.createElement('div');
    si.className = 'si';

    var lab1 = document.createElement('label');
    lab1.textContent = 'Service Name';
    lab1.style.cssText = 'font-size:0.8em;color:#aaa;margin-bottom:4px;display:block';

    var i1 = document.createElement('input');
    i1.type = 'text';
    i1.id = 'n' + n;
    i1.placeholder = 'Service name';
    i1.style.cssText = 'margin-bottom:8px;width:100%;background:#0a0a0a;border:1px solid #2a2a2a;padding:10px;border-radius:6px;color:#fff;font-size:0.85em;font-family:inherit';

    var lab2 = document.createElement('label');
    lab2.textContent = 'Annual Cost';
    lab2.style.cssText = 'font-size:0.8em;color:#aaa;margin-bottom:4px;display:block;margin-top:8px';

    var i2 = document.createElement('input');
    i2.type = 'number';
    i2.id = 'c' + n;
    i2.value = '0';
    i2.min = '0';
    i2.style.cssText = 'width:100%;background:#0a0a0a;border:1px solid #2a2a2a;padding:10px;border-radius:6px;color:#fff;font-size:0.85em;font-family:inherit';

    si.appendChild(lab1);
    si.appendChild(i1);
    si.appendChild(lab2);
    si.appendChild(i2);

    var lab3 = document.createElement('label');
    lab3.textContent = 'Post-HOAi Implementation';
    lab3.style.cssText = 'font-size:0.8em;color:#aaa;margin-bottom:4px;display:block;margin-top:8px';

    var tg = document.createElement('div');
    tg.className = 'toggle-group';

    var cancelBtn = document.createElement('button');
    cancelBtn.className = 'toggle-btn active-cancel';
    cancelBtn.textContent = 'Cancel';
    cancelBtn.setAttribute('data-svc', n);
    cancelBtn.setAttribute('data-action', 'cancel');

    var keepBtn = document.createElement('button');
    keepBtn.className = 'toggle-btn';
    keepBtn.textContent = 'Keep';
    keepBtn.setAttribute('data-svc', n);
    keepBtn.setAttribute('data-action', 'keep');

    tg.appendChild(cancelBtn);
    tg.appendChild(keepBtn);
    si.appendChild(lab3);
    si.appendChild(tg);

    var removeDiv = document.createElement('div');
    removeDiv.style.cssText = 'margin-top:12px;text-align:right';
    var rb = document.createElement('button');
    rb.textContent = 'Remove Service';
    rb.style.cssText = 'padding:6px 12px;font-size:0.8em;background:#6c757d;border:none;color:#fff;border-radius:6px;cursor:pointer';

    removeDiv.appendChild(rb);

    si.appendChild(removeDiv);
    d.appendChild(h);
    d.appendChild(si);
    g('addS').appendChild(d);

    cancelBtn.addEventListener('click', function() { toggleSvc(n, 'cancel'); });
    keepBtn.addEventListener('click', function() { toggleSvc(n, 'keep'); });

    rb.addEventListener('click', function(e) {
        e.stopPropagation();
        d.remove();
        calc();
    });

    i2.addEventListener('input', calc);
}

function setTF(y) {
    S.tf = y;
    var bs = document.querySelectorAll('#tfBtns button');
    for (var i = 0; i < bs.length; i++) {
        bs[i].classList.toggle('active', parseInt(bs[i].getAttribute('data-y')) === y);
    }
    calc();
}

// ============================================================================
// INITIALIZATION
// ============================================================================
function init() {
    var retries = 0;
    function tryInit() {
        if (typeof Chart === 'undefined') {
            if (retries++ < 10) setTimeout(tryInit, 500);
            return;
        }

        var inp = ['comm','doors','staff','growth','callOverride'];
        for (var i = 0; i < inp.length; i++) {
            var el = g(inp[i]);
            if (el) el.addEventListener('input', calc);
        }

        var sl = g('callSlider');
        var ci = g('callOverride');
        if (sl && ci) {
            sl.addEventListener('input', function() {
                ci.value = this.value;
                calc();
            });
            ci.addEventListener('input', function() {
                var val = Number(this.value);
                if (val <= 50000) {
                    sl.value = Math.round(val / 2500) * 2500;
                } else {
                    sl.value = 50000;
                }
                calc();
            });
        }

        var c1 = g('c1');
        if (c1) c1.addEventListener('input', calc);

        var s1Btns = document.querySelectorAll('#s1 .toggle-btn');
        s1Btns.forEach(function(btn) {
            btn.addEventListener('click', function() {
                toggleSvc(1, this.getAttribute('data-action'));
            });
        });

        var ab = g('addBtn');
        if (ab) ab.addEventListener('click', addS);

        var tfs = document.querySelectorAll('#tfBtns button');
        for (var k = 0; k < tfs.length; k++) {
            tfs[k].addEventListener('click', function() {
                setTF(parseInt(this.getAttribute('data-y')));
            });
        }

        var exp = g('expandBtn');
        if (exp) exp.addEventListener('click', toggleCharts);

        var expAssumptions = g('expAssumptions');
        if (expAssumptions) expAssumptions.addEventListener('click', function() {
            var div = g('assumptions');
            var btn = g('expAssumptions');
            if (div && btn) {
                if (div.classList.contains('show')) {
                    div.classList.remove('show');
                    div.classList.add('hide');
                    btn.classList.remove('expanded');
                    btn.textContent = 'View Detailed Assumptions';
                } else {
                    div.classList.remove('hide');
                    div.classList.add('show');
                    btn.classList.add('expanded');
                    btn.textContent = 'Hide Detailed Assumptions';
                }
            }
        });

        // Add FTE chart expand listener
        var expFTE = g('expFTE');
        if (expFTE) expFTE.addEventListener('click', function() { toggleDeep('FTE'); });

        for (var d = 1; d <= 4; d++) {
            (function(num) {
                var expBtn = g('exp' + num);
                if (expBtn) expBtn.addEventListener('click', function() { toggleDeep(num); });
            })(d);
        }

        var sendBtn = g('sendBtn');
        if (sendBtn) sendBtn.addEventListener('click', sendEmail);

        calc();
    }
    tryInit();
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}
})();
</script>
</body>
</html>
